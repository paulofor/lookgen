# Stylerâ€‘Service â€“ Codexâ€‘Ready Spec (MVP)

<!--
Esta versÃ£o Ã© otimizada para ser usada como "contexto" pelo OpenAI Codex/Copilot.  
ðŸ‘‰Â Sem tabelas HTML, diagramas ou formataÃ§Ã£o muito pesada.  
ðŸ‘‰Â Cada seÃ§Ã£o comeÃ§a com `##` ou `###`.  
ðŸ‘‰Â Tudo em texto puro ou blocos markdown de cÃ³digo.  
ðŸ‘‰Â Termosâ€‘chave aparecem em **CAPS** para facilitar busca.
-->

## META

* VERSION: `0.2` â€” 2025â€‘06â€‘20
* PURPOSE: Microâ€‘serviÃ§o que, periodicamente, pega 5 FOTOS do usuÃ¡rio, chama **GPTâ€‘4oâ€‘mini**, grava o ESBOÃ‡O e muda o STAGE do usuÃ¡rio.
* SCALE: volume â‰ˆÂ <100 sketches/dia â‡’ **SEM Redis / SEM Streaming**.

---

## TECH STACK

* **Spring BootÂ 3.3**Â (MVC) â€” KotlinÂ 1.9
* **PostgreSQLÂ 15** â€” tabelas `user`, `photo`, `sketch`
* **OpenAI Chat API** (`gpt-4o-mini`, `stream=false`)
* Container: `ghcr.io/lookgen/styler:<sha>`
* Deploy inicial: **1Â pod** (2Â vCPU,Â 1Â Gi)

---

## DATA MODEL (PostgreSQL)

```
USER(id PK BIGINT, stage ENUM, retry_count SMALLINT, updated_at TIMESTAMP)
PHOTO(id PK, user_id FK, url TEXT, ord SMALLINT)
SKETCH(id PK, user_id FK UNIQUE, content TEXT, tokens INT, created_at TIMESTAMP)
```

* STAGE values: `CAPTURED` â†’ `PENDING_SKETCH` â†’ `SKETCH_READY` â†” `SKETCH_ERROR`.

---

## PUBLIC API

```
GET  /actuator/health          # liveness / readiness
GET  /v1/sketch/{uid}          # returns {content, tokens}
POST /v1/admin/replay          # admin: reset stage & reprocess
```

* Frontend faz **poll** em `/v1/sketch/{uid}` atÃ© 200Â OK.

---

## SCHEDULER LOGIC (pseudocode)

```kotlin
@Scheduled(fixedDelay = 60_000)
@Transactional
fun tick() {
  val users = userRepo.findPending(limit = 5) // SELECT ... FOR UPDATE SKIP LOCKED
  users.forEach { u ->
    processUser(u)
  }
}

fun processUser(u: User) {
  val photos = photoRepo.findByUser(u.id)      // must be 5
  if (photos.size != 5) { fail(u) }

  val sketch = openAi.createSketch(photos.urls)
  sketchRepo.save(sketch)
  u.stage = Stage.SKETCH_READY
}
```

* **Retry:** atÃ© 3 tentativas (expo backoff). Se falha â‡’ `u.stage = SKETCH_ERROR`.

---

## OPENAI PAYLOAD (abridged)

```jsonc
{
  "model": "gpt-4o-mini",
  "stream": false,
  "messages": [
    {"role":"system","content":"VocÃª Ã© um estilista â€¦"},
    {"role":"user","content":[
      {"type":"text","text":"Crie um esboÃ§o:"},
      {"type":"image_url","image_url":{"url":"${url1}"}},
      {"type":"image_url","image_url":{"url":"${url2}"}},
      {"type":"image_url","image_url":{"url":"${url3}"}},
      {"type":"image_url","image_url":{"url":"${url4}"}},
      {"type":"image_url","image_url":{"url":"${url5}"}},
      {"type":"text","text":"Bullets, paleta e peÃ§asâ€‘chave."}
    ]}
  ]
}
```

---

## CONFIG (application.yaml â€“ excerto)

```yaml
styler:
  poll-ms: 60000   # 60Â s
openai:
  api-key: ${OPENAI_API_KEY}
  read-timeout: 120s
```

---

## METRICS (Micrometer)

* `sketch_jobs_total{state="done|error"}`
* `sketch_latency_seconds` (Timer)
* `openai_requests_total{status}`
* `openai_token_usage_total{type}`

---

## DONE CRITERIA (MVP)

* Migrations Flyway âœ…
* Scheduler gravando esboÃ§o âœ…
* Endpoint GET `/v1/sketch/{uid}` âœ…
* Dockerfile & Helm chart âœ…
* Grafana dashboard bÃ¡sico âœ…

<!-- EOF Codexâ€‘ready spec -->
